# Production Deployment Guide

## Prerequisites

- Linux server (Ubuntu 22.04+ recommended)
- Domain name with DNS configured
- SSL certificate (Let's Encrypt recommended)
- MySQL 8.0 or compatible
- PHP 8.4+ with required extensions
- Composer
- Nginx or Apache web server
- Supervisor (for queue workers)

## Server Requirements

### PHP Extensions Required
```bash
php -m | grep -E 'PDO|mbstring|tokenizer|xml|ctype|json|bcmath|fileinfo|openssl|mysql'
```

Required extensions:
- PDO
- pdo_mysql
- mbstring
- tokenizer
- xml
- ctype
- json
- bcmath
- fileinfo
- openssl

### System Packages
```bash
sudo apt update
sudo apt install -y \
  nginx \
  mysql-server \
  php8.4-fpm \
  php8.4-mysql \
  php8.4-mbstring \
  php8.4-xml \
  php8.4-bcmath \
  php8.4-curl \
  supervisor \
  git \
  composer
```

## Deployment Steps

### 1. Clone Repository

```bash
cd /var/www
sudo git clone https://github.com/your-org/deciflow-backend.git
cd deciflow-backend
sudo chown -R www-data:www-data /var/www/deciflow-backend
```

### 2. Install Dependencies

```bash
composer install --optimize-autoloader --no-dev
```

### 3. Environment Configuration

```bash
cp .env.example .env
php artisan key:generate
```

Edit `.env` for production:

```env
APP_NAME=DeciFlow
APP_ENV=production
APP_KEY=base64:...  # Generated by key:generate
APP_DEBUG=false
APP_URL=https://api.yourdomain.com

LOG_CHANNEL=stack
LOG_LEVEL=error

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=deciflow_prod
DB_USERNAME=deciflow_user
DB_PASSWORD=SecurePasswordHere

BROADCAST_DRIVER=log
CACHE_DRIVER=redis
FILESYSTEM_DISK=s3
QUEUE_CONNECTION=redis
SESSION_DRIVER=redis
SESSION_LIFETIME=120

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=your_username
MAIL_PASSWORD=your_password
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"

FRONTEND_URL=https://yourdomain.com

AWS_ACCESS_KEY_ID=
AWS_SECRET_ACCESS_KEY=
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=
AWS_USE_PATH_STYLE_ENDPOINT=false
```

### 4. Database Setup

```bash
# Create production database
sudo mysql -u root -p
```

```sql
CREATE DATABASE deciflow_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'deciflow_user'@'localhost' IDENTIFIED BY 'SecurePasswordHere';
GRANT ALL PRIVILEGES ON deciflow_prod.* TO 'deciflow_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

```bash
# Run migrations
php artisan migrate --force

# Seed initial data (roles, departments)
php artisan db:seed --class=RoleSeeder --force
php artisan db:seed --class=DepartmentSeeder --force

# Create admin user manually
php artisan tinker
>>> \App\Models\User::create([
...   'name' => 'Admin',
...   'email' => 'admin@yourdomain.com',
...   'password' => bcrypt('SecurePassword123'),
...   'role_id' => 1, // super_admin
...   'department_id' => 1
... ]);
```

### 5. File Permissions

```bash
sudo chown -R www-data:www-data /var/www/deciflow-backend
sudo chmod -R 755 /var/www/deciflow-backend
sudo chmod -R 775 /var/www/deciflow-backend/storage
sudo chmod -R 775 /var/www/deciflow-backend/bootstrap/cache
```

### 6. Optimize Laravel

```bash
# Cache configuration
php artisan config:cache

# Cache routes
php artisan route:cache

# Cache views
php artisan view:cache

# Optimize autoloader
composer dump-autoload --optimize
```

### 7. Nginx Configuration

Create `/etc/nginx/sites-available/deciflow`:

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.yourdomain.com;

    root /var/www/deciflow-backend/public;
    index index.php;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Logs
    access_log /var/log/nginx/deciflow-access.log;
    error_log /var/log/nginx/deciflow-error.log;

    # Max upload size
    client_max_body_size 10M;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

Enable site:
```bash
sudo ln -s /etc/nginx/sites-available/deciflow /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 8. SSL Certificate (Let's Encrypt)

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com
```

### 9. Queue Worker (Supervisor)

Create `/etc/supervisor/conf.d/deciflow-worker.conf`:

```ini
[program:deciflow-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/deciflow-backend/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/deciflow-backend/storage/logs/worker.log
stopwaitsecs=3600
```

Start worker:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start deciflow-worker:*
```

### 10. Cron Jobs (Task Scheduling)

```bash
sudo crontab -e -u www-data
```

Add:
```cron
* * * * * cd /var/www/deciflow-backend && php artisan schedule:run >> /dev/null 2>&1
```

## Security Hardening

### 1. Firewall (UFW)

```bash
sudo ufw allow 22/tcp     # SSH
sudo ufw allow 80/tcp     # HTTP
sudo ufw allow 443/tcp    # HTTPS
sudo ufw enable
```

### 2. Fail2Ban

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 3. Disable Debug Mode

Ensure in `.env`:
```env
APP_DEBUG=false
```

### 4. Secure Session

```env
SESSION_SECURE_COOKIE=true
SESSION_SAME_SITE=strict
```

### 5. Rate Limiting

Already configured in `config/sanctum.php` and route middleware.

## Monitoring & Maintenance

### Application Monitoring

**Option 1: Laravel Telescope (Development/Staging)**
```bash
composer require laravel/telescope
php artisan telescope:install
php artisan migrate
```

Access: `https://api.yourdomain.com/telescope`

**Option 2: External Services**
- New Relic
- DataDog
- Sentry (error tracking)

### Log Monitoring

```bash
# View Laravel logs
tail -f /var/www/deciflow-backend/storage/logs/laravel.log

# View Nginx access logs
tail -f /var/log/nginx/deciflow-access.log

# View Nginx error logs
tail -f /var/log/nginx/deciflow-error.log
```

### Database Backups

Create backup script `/usr/local/bin/backup-deciflow.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/deciflow"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Database backup
mysqldump -u deciflow_user -p'SecurePasswordHere' deciflow_prod | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Keep only last 7 days
find $BACKUP_DIR -name "db_*.sql.gz" -mtime +7 -delete

echo "Backup completed: db_$DATE.sql.gz"
```

Make executable:
```bash
sudo chmod +x /usr/local/bin/backup-deciflow.sh
```

Add to crontab:
```bash
sudo crontab -e
```

```cron
0 2 * * * /usr/local/bin/backup-deciflow.sh
```

## Deployment Workflow (CI/CD)

### GitHub Actions Example

`.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/deciflow-backend
            git pull origin main
            composer install --optimize-autoloader --no-dev
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            sudo systemctl reload php8.4-fpm
            sudo supervisorctl restart deciflow-worker:*
```

## Rollback Procedure

```bash
# Rollback database migration
php artisan migrate:rollback --step=1

# Rollback code (git)
cd /var/www/deciflow-backend
git log --oneline -5  # Find commit hash
git reset --hard <commit-hash>
composer install --optimize-autoloader --no-dev

# Clear caches
php artisan config:clear
php artisan route:clear
php artisan view:clear
php artisan cache:clear

# Restart services
sudo systemctl reload php8.4-fpm
sudo supervisorctl restart deciflow-worker:*
```

## Health Checks

### Manual Health Check

```bash
# Check app is running
curl https://api.yourdomain.com/up

# Check database connection
php artisan tinker
>>> DB::connection()->getPdo();
```

### Automated Monitoring

Use services like:
- UptimeRobot
- Pingdom
- StatusCake

Monitor:
- `https://api.yourdomain.com/up`
- Response time < 500ms
- Uptime > 99.9%

## Performance Optimization

### 1. OPcache

Edit `/etc/php/8.4/fpm/php.ini`:

```ini
opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.revalidate_freq=0
opcache.validate_timestamps=0
```

### 2. Redis Caching

```bash
sudo apt install redis-server
sudo systemctl enable redis-server
```

Update `.env`:
```env
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
```

### 3. Database Optimization

```sql
-- Add indexes if needed
CREATE INDEX idx_requests_status ON requests(status);
CREATE INDEX idx_approval_steps_role_status ON approval_steps(approver_role, status);
```

### 4. CDN for Static Assets

Use CloudFlare, AWS CloudFront, or similar.

## Troubleshooting

### Common Issues

**500 Error:**
```bash
# Check logs
tail -100 storage/logs/laravel.log

# Check permissions
ls -la storage/
sudo chmod -R 775 storage/
sudo chown -R www-data:www-data storage/
```

**Database Connection Failed:**
```bash
# Test connection
php artisan tinker
>>> DB::connection()->getPdo();

# Check MySQL status
sudo systemctl status mysql
```

**Queue not processing:**
```bash
# Check supervisor
sudo supervisorctl status

# Restart worker
sudo supervisorctl restart deciflow-worker:*

# Check worker logs
tail -f storage/logs/worker.log
```

## Support & Resources

- Laravel Documentation: https://laravel.com/docs
- Server Requirements: https://laravel.com/docs/deployment
- Forge (managed hosting): https://forge.laravel.com
